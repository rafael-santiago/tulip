#
#                           Copyright (C) 2005-2016 by Rafael Santiago
#
# This is a free software. You can redistribute it and/or modify under
# the terms of the GNU General Public License version 2.
#
#
function has_valgrind() : result type int {
    if (hefesto.sys.os_name() == "windows") {
        result 0;
    }
    var no_valgrind type list;
    $no_valgrind = hefesto.sys.get_option("test-options");
    if ($no_valgrind.count() > 0) {
        if ($no_valgrind.index_of("--no-valgrind") > -1) {
            result 0;
        }
    }
    result (hefesto.sys.run("valgrind --version >/dev/null 2>&1") == 0);
}

function wrap_cmdline_with_valgrind(cmdline type string, logpath type string) : result type string {
    result "valgrind --tool=memcheck --leak-check=full --show-leak-kinds=all --log-file=" + $logpath + " " + $cmdline;
}

function print_tester_monkey_banner() : result type string {
    var username type string;
    $username = hefesto.sys.env("USER");
    if ($username.len() == 0) {
        $username = hefesto.sys.env("USERNAME");
        if ($username.len() == 0) {
            $username = "User";
        }
    }
    if ($username != "User") {
        $username = "user " + $username;
    }
    hefesto.sys.echo("________________________________________________________\n\n" +
                     "Hello beloved " + $username + "! I am the Tulip's Tester Monkey...\n" +
                     " For your best software experience,\n" +
                     "    I will test the generated software...\n" +
                     "  You know... in order to see if everything is fine... etc.\n" +
                     "    I think Rafael took care to make it acceptable for us.\n" +
                     "     At least since the last time I saw him he told me:\n" +
                     "        \"- Dude, the Tulip is working fine on my system!!!\"\n" +
                     "       So, let's proof what he said before start using Tulip...\n" +
                     "    Maybe these tests can take some time, please be patient...\n" +
                     "        I am just a testholic monkey!!\n" +
                     "          __\n" +
                     "     w  c(..)o   (\n" +
                     "      \\__(-)    __)\n" +
                     "          /\\   (\n" +
                     "         /(_)___)\n" +
                     "         w /|\n" +
                     "          | \\\n" +
                     "         m  m\n" +
                     "________________________________________________________\n\n");
}

function print_test_monkey_end_banner(tests_exit_code type int) : result type string {
    hefesto.sys.echo("\n________________________________________________________\n\n");
    if ($tests_exit_code == 0) {
        hefesto.sys.echo("*** NICE: Rafael got reason, all is fine in Tulip! You can start using it just now! Enjoy it!\n");
    } else {
        hefesto.sys.echo("~~~ Oops: I found some issues during the tests. It would be nice let Rafael know.\n");
        hefesto.sys.echo("          Please, open a issue on https://github.com/rafael-santiago/tulip/issues.\n");
        hefesto.sys.echo("          Attach to your issue the file test/test.log.\n");
        hefesto.sys.echo("    Thanks!\n");
    }
}
